generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Order {
  id             Int       @id @default(autoincrement())
  rk             String
  city           String
  avitoName      String?   @map("avito_name")
  phone          String
  typeOrder      String    @map("type_order")
  clientName     String    @map("client_name")
  address        String
  dateMeeting    DateTime  @map("date_meeting")
  typeEquipment  String    @map("type_equipment")
  problem        String
  callRecord     String?   @map("call_record")
  statusOrder    String    @map("status_order")
  masterId       Int?      @map("master_id")
  result         Decimal?  @db.Decimal(10, 2)
  expenditure    Decimal?  @db.Decimal(10, 2)
  clean          Decimal?  @db.Decimal(10, 2)
  masterChange   Decimal?  @map("master_change") @db.Decimal(10, 2)
  bsoDoc         String[]  @default([]) @map("bso_doc")
  expenditureDoc String[]  @default([]) @map("expenditure_doc")
  operatorNameId Int       @map("operator_name_id")
  createDate     DateTime  @map("create_date")
  closingData    DateTime? @map("closing_data")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  avitoChatId    String?   @map("avito_chatid")
  callId         String?   @map("call_id")
  prepayment     Decimal?  @db.Decimal(10, 2)
  dateClosmod    DateTime? @map("date_closmod")
  comment        String?
  
  cashSubmissionStatus String?   @map("cash_submission_status")
  cashSubmissionDate   DateTime? @map("cash_submission_date")
  cashSubmissionAmount Decimal?  @map("cash_submission_amount") @db.Decimal(10, 2)
  cashReceiptDoc       String?   @map("cash_receipt_doc")
  
  partner              Boolean?  @default(false)
  partnerPercent       Decimal?  @map("partner_percent") @db.Decimal(5, 2)

  operator CallcentreOperator @relation(fields: [operatorNameId], references: [id])
  master   Master?             @relation(fields: [masterId], references: [id])

  // ✅ ИСПРАВЛЕНИЕ: Добавлены недостающие индексы для оптимизации запросов
  @@index([statusOrder, city])
  @@index([closingData])
  @@index([masterId, city, closingData])
  @@index([phone])
  @@index([createDate, city])
  @@index([operatorNameId])
  @@index([createDate])
  @@index([clientName]) // ✅ Для поиска по имени клиента
  @@index([address]) // ✅ Для поиска по адресу
  @@index([statusOrder, masterId]) // ✅ Частая комбинация фильтров
  @@index([avitoChatId]) // ✅ Для поиска по чатам Avito
  @@index([cashSubmissionStatus]) // ✅ Для фильтрации по статусу сдачи кассы
  // ✅ FIX: Индексы для getFilterOptions DISTINCT запросов (исправляет timeout >10s)
  @@index([city]) // Для WHERE city = ANY($1::text[])
  @@index([city, rk]) // Для SELECT DISTINCT rk WHERE city
  @@index([city, typeEquipment]) // Для SELECT DISTINCT type_equipment WHERE city
  @@index([rk]) // Для DISTINCT rk без фильтра
  @@index([typeEquipment]) // Для DISTINCT type_equipment без фильтра
  @@map("orders")
}

model CallcentreOperator {
  id         Int      @id @default(autoincrement())
  name       String
  login      String   @unique
  password   String
  city       String
  status     String
  statusWork String   @map("status_work")
  passport   String?
  contract   String?
  dateCreate DateTime @map("date_create")
  note       String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  sipAddress String?  @map("sip_address")
  
  orders Order[]

  @@map("callcentre_operator")
}

model Master {
  id          Int      @id @default(autoincrement())
  cities      String[]
  name        String
  login       String?  @unique
  password    String?
  passportDoc String?  @map("passport_doc")
  contractDoc String?  @map("contract_doc")
  statusWork  String   @map("status_work")
  dateCreate  DateTime @default(now()) @map("date_create")
  note        String?
  tgId        String?  @map("tg_id")
  chatId      String?  @map("chat_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  orders Order[]

  @@map("master")
}

model Director {
  id          Int      @id @default(autoincrement())
  cities      String[]
  name        String
  login       String   @unique
  password    String
  contractDoc String?  @map("contract_doc")
  passportDoc String?  @map("passport_doc")
  dateCreate  DateTime @default(now()) @map("date_create")
  note        String?
  tgId        String?  @map("tg_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("director")
}

model Call {
  id           Int      @id @default(autoincrement())
  rk           String
  city         String
  avitoName    String?  @map("avito_name")
  phoneClient  String   @map("phone_client")
  phoneAts     String   @map("phone_ats")
  dateCreate   DateTime @map("date_create")
  operatorId   Int      @map("operator_id")
  status       String
  callId       String?  @unique @map("call_id")
  duration     Int?
  recordUrl    String?  @map("record_url")
  recordingPath String? @map("recording_path")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("calls")
  @@index([city])
  @@index([dateCreate])
  @@index([operatorId])
  @@index([phoneClient])
  @@index([callId])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  timestamp DateTime @default(now())
  eventType String   @db.VarChar(100)
  userId    Int?
  role      String?  @db.VarChar(50)
  login     String?  @db.VarChar(255)
  ip        String   @db.VarChar(45)
  userAgent String   @db.Text
  success   Boolean
  metadata  Json?    @db.JsonB

  @@index([userId, timestamp(sort: Desc)])
  @@index([eventType, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])
  @@map("audit_logs")
}

