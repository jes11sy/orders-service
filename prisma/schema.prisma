generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ✅ FIX #166: Добавлены VarChar ограничения для защиты от unbounded input
model Order {
  id             Int       @id @default(autoincrement())
  rk             String    @db.VarChar(50)
  city           String    @db.VarChar(100)
  avitoName      String?   @map("avito_name") @db.VarChar(255)
  phone          String    @db.VarChar(20)
  typeOrder      String    @map("type_order") @db.VarChar(100)
  clientName     String    @map("client_name") @db.VarChar(255)
  address        String    @db.Text // Адрес может быть длинным
  dateMeeting    DateTime  @map("date_meeting")
  typeEquipment  String    @map("type_equipment") @db.VarChar(100)
  problem        String    @db.Text // Описание проблемы может быть длинным
  callRecord     String?   @map("call_record") @db.Text // Запись звонка
  statusOrder    String    @map("status_order") @db.VarChar(50)
  masterId       Int?      @map("master_id")
  result         Decimal?  @db.Decimal(10, 2)
  expenditure    Decimal?  @db.Decimal(10, 2)
  clean          Decimal?  @db.Decimal(10, 2)
  masterChange   Decimal?  @map("master_change") @db.Decimal(10, 2)
  bsoDoc         String[]  @default([]) @map("bso_doc")
  expenditureDoc String[]  @default([]) @map("expenditure_doc")
  operatorNameId Int       @map("operator_name_id")
  createDate     DateTime  @map("create_date")
  closingData    DateTime? @map("closing_data")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  avitoChatId    String?   @map("avito_chatid") @db.VarChar(100)
  callId         String?   @map("call_id") @db.VarChar(100)
  prepayment     Decimal?  @db.Decimal(10, 2)
  dateClosmod    DateTime? @map("date_closmod")
  comment        String?   @db.Text // Комментарий может быть длинным
  
  cashSubmissionStatus String?   @map("cash_submission_status") @db.VarChar(50)
  cashSubmissionDate   DateTime? @map("cash_submission_date")
  cashSubmissionAmount Decimal?  @map("cash_submission_amount") @db.Decimal(10, 2)
  cashReceiptDoc       String?   @map("cash_receipt_doc") @db.VarChar(500)
  
  partner              Boolean?  @default(false)
  partnerPercent       Decimal?  @map("partner_percent") @db.Decimal(5, 2)

  // ✅ FIX #146: Добавлены onDelete для предотвращения orphaned records
  operator CallcentreOperator @relation(fields: [operatorNameId], references: [id], onDelete: Restrict)
  master   Master?             @relation(fields: [masterId], references: [id], onDelete: SetNull)

  // ✅ FIX #167: Оптимизированные индексы (удалены дубликаты)
  @@index([statusOrder, city])
  @@index([closingData])
  @@index([masterId, city, closingData])
  @@index([phone])
  @@index([createDate, city])           // ✅ Покрывает createDate-only запросы (leftmost prefix)
  @@index([operatorNameId])
  // REMOVED: @@index([createDate]) — дубликат, покрыт [createDate, city]
  @@index([clientName])
  // REMOVED: @@index([address]) — TEXT поля неэффективны для B-tree, используйте FTS
  @@index([statusOrder, masterId])
  @@index([avitoChatId])
  @@index([cashSubmissionStatus])
  @@index([city])                       // Для WHERE city = ANY($1::text[])
  @@index([city, rk])
  @@index([city, typeEquipment])
  @@index([rk])
  @@index([typeEquipment])
  @@map("orders")
}

model CallcentreOperator {
  id         Int      @id @default(autoincrement())
  name       String   @db.VarChar(255)
  login      String   @unique @db.VarChar(255)
  password   String   @db.VarChar(255)
  city       String   @db.VarChar(100)
  status     String   @db.VarChar(50)
  statusWork String   @map("status_work") @db.VarChar(50)
  passport   String?  @db.VarChar(500)
  contract   String?  @db.VarChar(500)
  dateCreate DateTime @map("date_create")
  note       String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  sipAddress String?  @map("sip_address") @db.VarChar(255)
  
  orders Order[]

  @@map("callcentre_operator")
}

model Master {
  id          Int      @id @default(autoincrement())
  cities      String[]
  name        String   @db.VarChar(255)
  login       String?  @unique @db.VarChar(255)
  password    String?  @db.VarChar(255)
  passportDoc String?  @map("passport_doc") @db.VarChar(500)
  contractDoc String?  @map("contract_doc") @db.VarChar(500)
  statusWork  String   @map("status_work") @db.VarChar(50)
  dateCreate  DateTime @default(now()) @map("date_create")
  note        String?  @db.Text
  tgId        String?  @map("tg_id") @db.VarChar(50)
  chatId      String?  @map("chat_id") @db.VarChar(50)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  orders Order[]

  @@map("master")
}

model Director {
  id          Int      @id @default(autoincrement())
  cities      String[]
  name        String   @db.VarChar(255)
  login       String   @unique @db.VarChar(255)
  password    String   @db.VarChar(255)
  contractDoc String?  @map("contract_doc") @db.VarChar(500)
  passportDoc String?  @map("passport_doc") @db.VarChar(500)
  dateCreate  DateTime @default(now()) @map("date_create")
  note        String?  @db.Text
  tgId        String?  @map("tg_id") @db.VarChar(50)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("director")
}

model Call {
  id           Int      @id @default(autoincrement())
  rk           String   @db.VarChar(50)
  city         String   @db.VarChar(100)
  avitoName    String?  @map("avito_name") @db.VarChar(255)
  phoneClient  String   @map("phone_client") @db.VarChar(20)
  phoneAts     String   @map("phone_ats") @db.VarChar(20)
  dateCreate   DateTime @map("date_create")
  operatorId   Int      @map("operator_id")
  status       String   @db.VarChar(50)
  callId       String?  @unique @map("call_id") @db.VarChar(100)
  duration     Int?
  recordUrl    String?  @map("record_url") @db.VarChar(500)
  recordingPath String? @map("recording_path") @db.VarChar(500)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("calls")
  @@index([city])
  @@index([dateCreate])
  @@index([operatorId])
  @@index([phoneClient])
  @@index([callId])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  timestamp DateTime @default(now())
  eventType String   @db.VarChar(100)
  userId    Int?
  role      String?  @db.VarChar(50)
  login     String?  @db.VarChar(255)
  ip        String   @db.VarChar(45)
  userAgent String   @db.Text
  success   Boolean
  metadata  Json?    @db.JsonB

  @@index([userId, timestamp(sort: Desc)])
  @@index([eventType, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])
  @@map("audit_logs")
}

model ErrorLog {
  id            Int      @id @default(autoincrement())
  timestamp     DateTime @default(now())
  service       String   @db.VarChar(100)
  errorType     String   @map("error_type") @db.VarChar(255)
  errorMessage  String   @map("error_message") @db.Text
  stackTrace    String?  @map("stack_trace") @db.Text
  userId        Int?     @map("user_id")
  userRole      String?  @map("user_role") @db.VarChar(50)
  requestUrl    String?  @map("request_url") @db.VarChar(500)
  requestMethod String?  @map("request_method") @db.VarChar(10)
  ip            String?  @db.VarChar(45)
  userAgent     String?  @map("user_agent") @db.Text
  metadata      Json?    @db.JsonB

  @@index([timestamp(sort: Desc)])
  @@index([service, timestamp(sort: Desc)])
  @@index([errorType])
  @@index([userId])
  @@map("error_logs")
}

// Заявки с сайта
model SiteOrder {
  id              Int      @id @default(autoincrement())
  city            String   @db.VarChar(100)
  site            String   @db.VarChar(255)
  clientName      String   @map("client_name") @db.VarChar(255)
  phone           String   @db.VarChar(20)
  status          String   @db.VarChar(50) @default("Создан")
  comment         String?  @db.Text
  commentOperator String?  @map("comment_operator") @db.Text
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  orderId         Int?     @map("order_id")

  @@index([status])
  @@index([city])
  @@index([createdAt(sort: Desc)])
  @@map("site_orders")
}

